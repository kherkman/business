<!DOCTYPE html>
<html>
<head>
<title>Planning Pivot</title>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
/* TÄYSIN TUMMA TEEMA - CSS VARIABLES */
:root {
--bg-body: #000000; /* Täysin musta tausta bodylle */
--bg-container: #121212; /* Hyvin tumma harmaa säiliöille */
--bg-element: #1e1e1e; /* Hieman vaaleampi elementeille */
--bg-hover: #333333; /* Hover-efekti */
--accent-color: #4a90e2; /* Sininen korostusväri */
--text-white: #ffffff; /* Puhtaan valkoinen teksti */
--border-color: #333333; /* Tumma reunus */
}

body {
        font-family: 'Poppins', sans-serif;
        font-size: 1.0em;
        margin: 0;
        background-color: var(--bg-body);
        color: var(--text-white);
    }

    header {
        background-color: var(--bg-container);
        padding: 20px 40px;
        border-bottom: 1px solid var(--border-color);
    }

    h1 {
        margin: 0;
        font-size: 1.8em;
        color: var(--text-white);
        font-weight: 600;
    }

    .main-container {
        padding: 30px 40px;
    }

    .controls {
        margin-bottom: 25px;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .btn {
        background-color: var(--accent-color);
        color: var(--text-white);
        border: none;
        padding: 12px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1em;
        font-weight: 600;
    }

    .btn:hover {
        background-color: #357abd;
    }

    #pivot-container {
        width: 100%;
        overflow: auto;
        background-color: var(--bg-container);
        padding: 20px;
        border-radius: 8px;
        border: 2px solid var(--border-color);
        box-sizing: border-box;
        color: var(--text-white);
    }

    /* --- PIVOT TABLE STYLES (FORCE DARK & WHITE TEXT) --- */

    /* Pakota kaikki teksti valkoiseksi pivot-taulukon sisällä */
    #pivot-container * {
        color: var(--text-white) !important;
    }

    /* Taulukon perusrakenne */
    table.pvtTable {
        background-color: var(--bg-container) !important;
        border-collapse: collapse;
    }

    /* Otsikot ja solut */
    .pvtTable thead tr th, 
    .pvtTable tbody tr th, 
    .pvtTable tbody tr td {
        background-color: var(--bg-container) !important;
        border: 1px solid var(--border-color) !important;
        padding: 10px;
    }

    /* Rivi- ja sarakeotsikot (tummempi tausta erottuvuuden vuoksi) */
    .pvtRowLabel, .pvtColLabel {
        font-size: 1.2em !important; 
        background-color: #000000 !important;
        font-weight: bold;
    }

    /* Arvosolut */
    .pvtVal {
        font-size: 1.2em !important; 
        background-color: var(--bg-container) !important;
        cursor: pointer;
        touch-action: manipulation; /* Estää zoomauksen mobiilissa */
    }

    /* Yhteissummat */
    .pvtTotal, .pvtGrandTotal {
        font-size: 1.2em !important; 
        background-color: #1a1a1a !important; /* Hieman eri sävy */
        font-weight: bold;
    }

    /* Hover-efekti soluille */
    .pvtVal:hover, .pvtTotal:hover, .pvtGrandTotal:hover {
        background-color: var(--bg-hover) !important;
    }

    /* --- UI ELEMENTS (Drag & Drop alueet) --- */
    
    .pvtAxisContainer, .pvtVals {
        background-color: var(--bg-element) !important;
        border: 1px solid var(--border-color) !important;
        padding: 10px;
    }

    /* Raahattavat laatikot (Attributes) */
    .pvtAxisContainer li span.pvtAttr {
        background-color: #333 !important;
        border: 1px solid #555 !important;
        border-radius: 4px;
        padding: 5px 10px;
    }

    /* --- DROPDOWNS (ALASVETOVALIKOT) --- */

    /* Table, Sum ja Euros valikot */
    #pivot-container select, 
    .pvtDropdown, 
    .pvtRenderer, 
    .pvtAggregator, 
    .pvtAttrDropdown {
        background-color: var(--bg-element) !important;
        color: var(--text-white) !important;
        border: 1px solid var(--border-color) !important;
        padding: 5px;
        cursor: pointer;
    }

    /* Valikon sisällä olevat vaihtoehdot (options) */
    #pivot-container select option {
        background-color: #000000 !important;
        color: var(--text-white) !important;
    }

    /* --- INPUTS --- */

    /* Muokattava input-kenttä solun sisällä */
    #pivot-container input[type='number'] {
        background-color: #000000 !important;
        border: 1px solid var(--accent-color) !important;
        color: white !important;
        padding: 5px;
        width: 90px;
        text-align: right;
    }

    /* Kolmiot ja ikonit */
    .pvtTriangle {
        border-top-color: white !important; /* Varmista että nuolet näkyy */
        border-bottom-color: white !important;
    }

    /* --- FILTER POPUP BOX --- */
    
    .pvtFilterBox {
        background-color: var(--bg-element) !important;
        border: 1px solid #555 !important;
        color: white !important;
    }

    .pvtFilterBox h4 {
        background-color: #000000 !important;
        border-bottom: 1px solid #555 !important;
        margin: 0;
        padding: 5px;
    }

    /* Haku-kenttä filtterissä */
    .pvtFilterBox input[type='text'] {
        background-color: #000000 !important;
        color: white !important;
        border: 1px solid #555 !important;
    }

    /* Checkbox-lista filtterissä */
    .pvtCheckContainer {
        background-color: var(--bg-element) !important;
        border: 1px solid #555 !important;
    }

    /* Painikkeet filtterissä (OK / Cancel) */
    .pvtFilterBox button {
        background-color: var(--accent-color) !important;
        color: white !important;
        border: none;
        padding: 5px 10px;
        margin-top: 5px;
        cursor: pointer;
    }
    
    .pvtFilterBox button:hover {
        background-color: #357abd !important;
    }

</style>
<!-- Dependencies -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

<!-- jQuery UI Touch Punch: Enables drag/drop on touch screens -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>

<link rel="stylesheet" type="text/css" href="https://pivottable.js.org/dist/pivot.css">
<script type="text/javascript" src="https://pivottable.js.org/dist/pivot.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
<header>
<h1>Planning Pivot</h1>
</header>
<div class="main-container">
    <div class="controls">
        <button class="btn" onclick="document.getElementById('csv-import').click();">Import CSV</button>
        <input type="file" id="csv-import" style="display:none;" accept=".csv">
        <button class="btn" id="export-csv">Export Updated CSV</button>
    </div>

    <div id="pivot-container"></div>
</div>

<script>
    let rawData = [
        { months: 'P1', accounts: '1 Sales', cost_centers: 'CC1', euros: 1500 },
        { months: 'P1', accounts: '3 Marketing', cost_centers: 'CC1', euros: 800 },
        { months: 'P1', accounts: '1 Sales', cost_centers: 'CC2', euros: 1200 },
        { months: 'P2', accounts: '1 Sales', cost_centers: 'CC1', euros: 1800 },
        { months: 'P2', accounts: '3 Marketing', cost_centers: 'CC2', euros: 1000 },
        { months: 'P3', accounts: '1 Sales', cost_centers: 'CC2', euros: 2200 },
        { months: 'P3', accounts: '2 HR', cost_centers: 'CC1', euros: 750 },
        { months: 'P4', accounts: '1 Sales', cost_centers: 'CC1', euros: 2000 },
    ];

    /**
     * Tämä funktio poistaa rivien yhdistämisen (rowspan).
     * Se kopioi otsikon (esim. CC1) jokaiselle riville, jotta näkymä on "litteä".
     */
    function ungroupRowHeaders() {
        const $rows = $('#pivot-container .pvtTable tbody tr');
        
        $rows.each(function(rowIndex) {
            const $row = $(this);
            const $headers = $row.find('th.pvtRowLabel');

            $headers.each(function(colIndex) {
                const $th = $(this);
                const rowspan = parseInt($th.attr('rowspan') || 1);

                if (rowspan > 1) {
                    $th.attr('rowspan', 1);

                    for (let r = 1; r < rowspan; r++) {
                        const $targetRow = $rows.eq(rowIndex + r);
                        const $clone = $th.clone();
                        
                        const $targetHeaders = $targetRow.find('th.pvtRowLabel');
                        
                        if (colIndex < $targetHeaders.length) {
                            $targetHeaders.eq(colIndex).before($clone);
                        } else {
                            const $vals = $targetRow.find('.pvtVal, .pvtTotal, .pvtRowTotal, .pvtGrandTotal');
                            if ($vals.length > 0) {
                                $vals.first().before($clone);
                            } else {
                                $targetRow.append($clone);
                            }
                        }
                    }
                }
            });
        });
    }

    // Global pivot table configuration
    const pivotConfig = {
        rows: ['cost_centers','accounts'],
        cols: ['months'],
        aggregatorName: 'Sum',
        vals: ['euros'],
        onRefresh: ungroupRowHeaders,
        renderers: $.extend($.pivotUtilities.renderers,
            $.pivotUtilities.plotly_renderers),
        localeStrings: {
            sum: "Sum",
            count: "Count",
            average: "Average",
            sumOverSum: "Sum over Sum",
            eightyPctMarginOfError: "80% MoE",
            rowLabel: "Row Label",
            colLabel: "Col Label",
            value: "Value",
            noValue: "No Value",
            "Grand Total": "Grand Total"
        }
    };

    function drawPivot(inputData) {
        $("#pivot-container").pivotUI(inputData, pivotConfig, false, "en");
    }

    $(function(){
        // Initial draw of the pivot table
        drawPivot(rawData);
        
        // Double-click handler for editable cells.
        // HUOM: Lisätty .pvtGrandTotal, jotta myös Grand Total -solu aktivoituu.
        $('#pivot-container').on('dblclick', '.pvtVal, .pvtTotal, .pvtGrandTotal', function() {
            const $this = $(this);
            if ($this.find('input').length) return;

            const pivotState = $("#pivot-container").data("pivotUIOptions");
            const filters = {};
            
            // --- GRAND TOTAL CHECK ---
            // Jos solu on Grand Total (oikea alanurkka), emme halua asettaa mitään filttereitä.
            // Tyhjä filters-objekti tarkoittaa "kaikki data", jolloin muutos jaetaan koko taulukkoon.
            const isGrandTotal = $this.hasClass('pvtGrandTotal');

            if (!isGrandTotal) {
                // --- HAE RIVIEN FILTTERIT (Vain jos EI ole Grand Total) ---
                const rowLabelCells = $this.closest('tr').find('.pvtRowLabel');
                pivotState.rows.forEach((key, i) => {
                    if (i < rowLabelCells.length && $(rowLabelCells[i]).text()) {
                        filters[key] = $(rowLabelCells[i]).text().trim();
                    }
                });

                // --- HAE SARAKKEIDEN FILTTERIT ---
                // Jos kyseessä ei ole rivisumma (Row Total), haetaan sarakkeet.
                if (!$this.hasClass('pvtRowTotal')) {
                    const dataColumnIndex = $this.prevAll('.pvtVal, .pvtTotal').length;
                    const $theadRows = $this.closest('table').find('thead > tr');
                    
                    pivotState.cols.forEach((colKey, colDimIndex) => {
                        const $headerRow = $theadRows.eq(colDimIndex);
                        const $colHeaders = $headerRow.find('th.pvtColLabel');
                        let currentDataColCount = 0;
                        
                        $colHeaders.each(function() {
                            const $th = $(this);
                            const span = parseInt($th.attr('colspan') || 1);
                            
                            if (dataColumnIndex >= currentDataColCount && dataColumnIndex < currentDataColCount + span) {
                                filters[colKey] = $th.text().trim();
                                return false; 
                            }
                            currentDataColCount += span;
                        });
                    });
                }
            }
            // Jos isGrandTotal on tosi, koodi hyppää suoraan tänne ja filters on {}.

            const oldValue = parseFloat($this.text().replace(/,/g, '')) || 0;
            const input = $(`<input type='number' value='${oldValue}' />`);
            $this.html(input); 
            input.focus().select(); 

            input.on('keydown', function(e) {
                if (e.key === 'Enter' || e.keyCode === 13) {
                    e.preventDefault();
                    $(this).blur(); 
                }
            });

            input.on('blur', function() {
                const newValue = parseFloat($(this).val());
                
                if (isNaN(newValue)) {
                    $this.text(oldValue.toLocaleString('en'));
                    return;
                }
                
                if ($this.hasClass('pvtVal')) {
                    // ACTION 1: Yksittäinen arvosolu
                    const allDimKeys = [...pivotState.rows, ...pivotState.cols].filter(k => filters[k]);
                    const hasAllKeys = allDimKeys.length === Object.keys(filters).length;

                    let itemToUpdate = rawData.find(item => {
                        for (const key in filters) {
                            if (item[key] != filters[key]) return false;
                        }
                        return true;
                    });

                    if (itemToUpdate) {
                        itemToUpdate.euros = newValue;
                    } else if (hasAllKeys && allDimKeys.length > 0) {
                        const newItem = { ...filters, euros: newValue };
                        rawData.push(newItem);
                    }

                } else {
                    // ACTION 2: Summa-tason muokkaus (Row Total, Col Total, tai Grand Total)
                    // Jos filters on tyhjä (Grand Total), tämä hakee kaiken datan.
                    const dataToUpdate = rawData.filter(item => {
                        for (const key in filters) {
                            if (item[key] != filters[key]) return false;
                        }
                        return true;
                    });

                    if (dataToUpdate.length > 0) {
                        const currentSum = dataToUpdate.reduce((sum, item) => sum + (item.euros || 0), 0);
                        if (currentSum === 0) {
                            const perItemValue = newValue / dataToUpdate.length;
                            dataToUpdate.forEach(item => { item.euros = perItemValue; });
                        } else {
                            const ratio = newValue / currentSum;
                            dataToUpdate.forEach(item => { item.euros = (item.euros || 0) * ratio; });
                        }
                    }
                }
                
                drawPivot(rawData); 
            });
        });

        // --- Import CSV handler ---
        $('#csv-import').on('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                Papa.parse(file, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        results.data.forEach(row => {
                            if (typeof row.euros === 'string') {
                                row.euros = parseFloat(row.euros.replace(/,/g, ''));
                            }
                            if (isNaN(row.euros)) {
                                row.euros = 0;
                            }
                        });
                        rawData = results.data;
                        drawPivot(rawData);
                        e.target.value = '';
                    }
                });
            }
        });

        // --- Export CSV handler ---
        $('#export-csv').on('click', function() {
            const csv = Papa.unparse(rawData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "budget_data_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        });
    });
</script>
</body>
</html>
